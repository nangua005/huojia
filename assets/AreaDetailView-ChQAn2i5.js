import{_ as ie,r as x,w as h,o as se,c as L,a as V,b as i,d as n,t as g,e as a,f as s,g as _,n as de,u as ce,h as ee,i as _e,j as we,k as N,l as te,m as xe,p as ke,q as le,F as ne,s as oe,v as ae,x as J}from"./index-BG42uTjs.js";const be={class:"scan-container"},Ce={style:{"margin-top":"10px","word-break":"break-all"}},Ve={__name:"ScanDialog",props:{modelValue:Boolean},emits:["update:modelValue","success"],setup(K,{emit:R}){const z=K,S=R,m=x(z.modelValue);h(()=>z.modelValue,v=>m.value=v),h(m,v=>S("update:modelValue",v));const r=x(null),w=x("等待扫码...");let k=null,u=null;const I=async()=>{try{u&&u.getTracks().forEach(v=>v.stop())}catch(v){console.warn("关闭摄像头失败：",v)}u=null,r.value&&(r.value.pause(),r.value.srcObject=null)},T=async()=>{w.value="等待扫码...",await de(),await ZXingBrowser.BrowserQRCodeReader.wasmBindingsReady;const y=(await navigator.mediaDevices.enumerateDevices()).find(p=>p.kind==="videoinput");if(!y){w.value="❌ 没有找到摄像头";return}try{for(u=await navigator.mediaDevices.getUserMedia({video:{deviceId:y.deviceId,facingMode:"environment",width:{ideal:1280},height:{ideal:720}}}),r.value.srcObject=u,await new Promise(p=>{const b=()=>{r.value.removeEventListener("canplay",b),p()};r.value.addEventListener("canplay",b)}),k||(k=new ZXingBrowser.BrowserMultiFormatReader);m.value;){try{const p=await k.decodeOnceFromVideoElement(r.value);if(p){const b=p.getText();w.value="✅ 扫码成功："+b,S("success",b),setTimeout(()=>{c()},1500);break}}catch{}await new Promise(p=>setTimeout(p,60))}}catch(p){w.value="❌ 摄像头启动失败："+p}},c=async()=>{m.value=!1,await I()};return h(m,v=>{v&&T()}),se(I),(v,y)=>{const p=_("el-button"),b=_("el-dialog");return V(),L(b,{title:"扫码输入",modelValue:m.value,"onUpdate:modelValue":y[0]||(y[0]=E=>m.value=E),width:"90%","close-on-click-modal":!1,"destroy-on-close":!0,onClose:c},{footer:i(()=>[a(p,{onClick:c},{default:i(()=>y[3]||(y[3]=[s("取消")])),_:1,__:[3]})]),default:i(()=>[n("div",be,[n("video",{ref_key:"videoRef",ref:r,autoplay:"",muted:"",playsinline:"",class:"scan-video"},null,512),y[1]||(y[1]=n("div",{class:"scan-frame"},[n("div",{class:"scan-line"})],-1)),y[2]||(y[2]=n("div",{class:"scan-tip"},"请将条码放入红框中进行扫描",-1))]),n("div",Ce,g(w.value),1)]),_:1},8,["modelValue"])}}},$e=ie(Ve,[["__scopeId","data-v-9a954ae2"]]),Se={style:{padding:"20px"}},Ie={style:{"margin-bottom":"20px"}},ze={style:{"margin-bottom":"10px"}},Be={style:{"text-align":"right","margin-bottom":"20px"}},De={style:{display:"flex","justify-content":"space-between"}},Ne={style:{flex:"1 1 80%",overflow:"hidden","text-overflow":"ellipsis"}},Re={style:{flex:"1 1 20%","text-align":"right"}},Te={style:{display:"flex","justify-content":"space-between"}},Ue={style:{flex:"1 1 80%",overflow:"hidden","text-overflow":"ellipsis"}},Oe={style:{flex:"1 1 20%","text-align":"right"}},he={key:0,style:{"margin-top":"5px"}},Ee={style:{"margin-top":"5px"}},je={style:{display:"flex","align-items":"center",gap:"5px"}},Me={style:{"margin-top":"5px",display:"flex","align-items":"center",gap:"5px"}},Fe={style:{"margin-top":"5px",display:"flex","align-items":"center",gap:"5px"}},Je={style:{display:"flex","justify-content":"space-between"}},Le={style:{flex:"1 1 80%",overflow:"hidden","text-overflow":"ellipsis"}},Ke={style:{flex:"1 1 20%","text-align":"right"}},Pe={style:{display:"flex","justify-content":"space-between"}},Xe={style:{flex:"1 1 80%",overflow:"hidden","text-overflow":"ellipsis"}},Ze={style:{flex:"1 1 20%","text-align":"right"}},Ae={key:0,style:{"margin-top":"5px"}},Qe={style:{"margin-top":"5px"}},qe={style:{display:"flex","align-items":"center",gap:"5px"}},He={style:{"margin-top":"5px",display:"flex","align-items":"center",gap:"5px"}},Ye={style:{padding:"10px",maxHeight:"60vh",overflowY:"auto"}},Ge={__name:"AreaDetailView",setup(K){const R=ce(),z=ke(),S=R.params.shelfNo,m=R.params.area,r=x(null),w=x(!1),k=x(!1),u=x({id:"",count:1,type:"good"}),I=ee(()=>(r.value?.areas[m]||[]).filter(t=>t.type==="good")),T=ee(()=>(r.value?.areas[m]||[]).filter(t=>t.type==="bad")),c=x({}),v=_e({}),y=t=>{u.value.id=t},p=t=>({left:"左侧",center:"中间",right:"右侧"})[t]||t,b=()=>z.push(`/shelf/${S}`),E=async()=>{const t=await xe(S);if(t){r.value=t;for(const e of t.areas[m])e._expanded=!1}},P=t=>t._expanded=!t._expanded,X=t=>{u.value={id:"",count:1,type:t},w.value=!0},re=async()=>{const t={id:u.value.id,count:u.value.count,name:"",type:u.value.type,_expanded:!1};r.value.areas[m]||(r.value.areas[m]=[]),r.value.areas[m].push(t),c.value[t.id]||(c.value[t.id]=[]),await J(JSON.parse(JSON.stringify(r.value))),ve(),w.value=!1},Z=async t=>{r.value.areas[m].splice(t,1),await J(JSON.parse(JSON.stringify(r.value)))},C=(t,e,o)=>{const f=t==="good"?I.value:T.value;e<0||e>=f.length||(f[e].count+=o,f[e].count<1&&(f[e].count=1),J(JSON.parse(JSON.stringify(r.value))))},ue=(t,e)=>{const o=I.value;if(e<0||e>=o.length)return;const f=o[e].id;z.push(`/product?id=${encodeURIComponent(f)}`)},U=t=>c.value[t]||[],A=t=>{const e=(v[t]||"").trim();e&&(c.value[t]||(c.value[t]=[]),c.value[t].includes(e)||c.value[t].push(e),v[t]="")},Q=(t,e)=>{c.value[t]?.splice(e,1)},ve=()=>{u.value={id:"",count:1,type:"good"}},$=x(null),O=x("等待扫码...");let j=null,B=null;h(k,t=>{t?me():M()});const q=()=>{O.value="等待扫码..."},M=async()=>{k.value=!1,q();try{B&&B.getTracks().forEach(t=>t.stop())}catch(t){console.warn("扫码停止失败：",t),alert("扫码停止失败："+t)}B=null;try{$.value&&($.value.pause(),$.value.srcObject=null)}catch(t){console.warn("视频元素清理失败："+t),alert("视频元素清理失败：")}},me=async()=>{q(),await de(),O.value="等待扫码...",await ZXingBrowser.BrowserQRCodeReader.wasmBindingsReady;const e=(await navigator.mediaDevices.enumerateDevices()).find(o=>o.kind==="videoinput");if(!e){O.value="❌ 没有找到摄像头";return}try{for(B=await navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId,facingMode:"environment",width:{ideal:1920},height:{ideal:1080}}}),$.value.srcObject=B,await new Promise(o=>{const f=()=>{$.value.removeEventListener("canplay",f),o()};$.value.addEventListener("canplay",f)}),j||(j=new ZXingBrowser.BrowserMultiFormatReader);;){try{const o=await j.decodeOnceFromVideoElement($.value);if(o){const f=o.getText();o.value="✅ 扫码成功："+f,u.value.id=f,M();break}}catch{}await new Promise(o=>setTimeout(o,33))}}catch(o){O.value="❌ 摄像头启动失败："+o}};return we(E),se(async()=>{await M()}),(t,e)=>{const o=_("el-button"),f=_("el-tag"),F=_("el-input"),H=_("el-table-column"),Y=_("el-table"),G=_("el-card"),W=_("el-form-item"),pe=_("el-input-number"),fe=_("el-form"),ye=_("el-dialog");return V(),N("div",Se,[n("div",Ie,[a(o,{type:"primary",onClick:b},{default:i(()=>e[8]||(e[8]=[s("返回货架详情")])),_:1,__:[8]})]),n("h2",ze,g(te(S))+" - "+g(p(te(m)))+" 区域",1),n("div",Be,[a(o,{type:"success",onClick:e[0]||(e[0]=l=>X("good"))},{default:i(()=>e[9]||(e[9]=[s("添加好货")])),_:1,__:[9]}),a(o,{type:"warning",onClick:e[1]||(e[1]=l=>X("bad"))},{default:i(()=>e[10]||(e[10]=[s("添加坏货")])),_:1,__:[10]})]),e[35]||(e[35]=n("h3",null,"好货列表",-1)),a(G,{style:{"margin-bottom":"10px",padding:"0px"}},{default:i(()=>[a(Y,{data:I.value,style:{width:"100%"},size:"small",border:""},{default:i(()=>[a(H,{label:"货物信息"},{default:i(l=>[n("div",De,[n("div",Ne,[e[11]||(e[11]=n("strong",null,"编号:",-1)),s(" "+g(l.row.id),1)]),n("div",Re,[e[12]||(e[12]=n("strong",null,"数量:",-1)),s(" "+g(l.row.count),1)])]),n("div",Te,[n("div",Ue,[e[13]||(e[13]=n("strong",null,"名称:",-1)),s(" "+g(U(l.row.id)[0]||"无"),1)]),n("div",Oe,[a(o,{size:"small",text:"",onClick:d=>P(l.row)},{default:i(()=>[s(g(l.row._expanded?"收起":"展开"),1)]),_:2},1032,["onClick"])])]),l.row._expanded?(V(),N("div",he,[e[20]||(e[20]=n("div",null,[n("strong",null,"标签:")],-1)),n("div",Ee,[(V(!0),N(ne,null,oe(U(l.row.id),(d,D)=>(V(),L(f,{key:D,closable:"",onClose:ge=>Q(l.row.id,D),style:{margin:"2px"}},{default:i(()=>[s(g(d),1)]),_:2},1032,["onClose"]))),128)),a(F,{modelValue:v[l.row.id],"onUpdate:modelValue":d=>v[l.row.id]=d,placeholder:"添加标签",size:"small",onKeyup:ae(d=>A(l.row.id),["enter"]),style:{width:"120px","margin-left":"5px"}},null,8,["modelValue","onUpdate:modelValue","onKeyup"])]),e[21]||(e[21]=n("div",{style:{"margin-top":"5px"}},[n("strong",null,"操作:")],-1)),n("div",je,[a(o,{size:"small",type:"primary",onClick:d=>C("good",l.$index,1)},{default:i(()=>e[14]||(e[14]=[s("+1")])),_:2,__:[14]},1032,["onClick"]),a(o,{size:"small",type:"primary",onClick:d=>C("good",l.$index,10)},{default:i(()=>e[15]||(e[15]=[s("+10")])),_:2,__:[15]},1032,["onClick"]),a(o,{size:"small",type:"danger",onClick:d=>Z("good",l.$index),style:{"margin-left":"auto"}},{default:i(()=>e[16]||(e[16]=[s(" 删除 ")])),_:2,__:[16]},1032,["onClick"])]),n("div",Me,[a(o,{size:"small",type:"primary",onClick:d=>C("good",l.$index,-1)},{default:i(()=>e[17]||(e[17]=[s("-1")])),_:2,__:[17]},1032,["onClick"]),a(o,{size:"small",type:"primary",onClick:d=>C("good",l.$index,-10)},{default:i(()=>e[18]||(e[18]=[s("-10")])),_:2,__:[18]},1032,["onClick"])]),n("div",Fe,[a(o,{size:"small",type:"primary",onClick:d=>ue("good",l.$index)},{default:i(()=>e[19]||(e[19]=[s("查询所有位置")])),_:2,__:[19]},1032,["onClick"])])])):le("",!0)]),_:1})]),_:1},8,["data"])]),_:1}),e[36]||(e[36]=n("h3",null,"坏货列表",-1)),a(G,{style:{"margin-bottom":"10px",padding:"0px"}},{default:i(()=>[a(Y,{data:T.value,style:{width:"100%"},size:"small",border:""},{default:i(()=>[a(H,{label:"货物信息"},{default:i(l=>[n("div",Je,[n("div",Le,[e[22]||(e[22]=n("strong",null,"编号:",-1)),s(" "+g(l.row.id),1)]),n("div",Ke,[e[23]||(e[23]=n("strong",null,"数量:",-1)),s(" "+g(l.row.count),1)])]),n("div",Pe,[n("div",Xe,[e[24]||(e[24]=n("strong",null,"名称:",-1)),s(" "+g(U(l.row.id)[0]||"无"),1)]),n("div",Ze,[a(o,{size:"small",text:"",onClick:d=>P(l.row)},{default:i(()=>[s(g(l.row._expanded?"收起":"展开"),1)]),_:2},1032,["onClick"])])]),l.row._expanded?(V(),N("div",Ae,[e[30]||(e[30]=n("div",null,[n("strong",null,"标签:")],-1)),n("div",Qe,[(V(!0),N(ne,null,oe(U(l.row.id),(d,D)=>(V(),L(f,{key:D,closable:"",onClose:ge=>Q(l.row.id,D),style:{margin:"2px"}},{default:i(()=>[s(g(d),1)]),_:2},1032,["onClose"]))),128)),a(F,{modelValue:v[l.row.id],"onUpdate:modelValue":d=>v[l.row.id]=d,placeholder:"添加标签",size:"small",onKeyup:ae(d=>A(l.row.id),["enter"]),style:{width:"120px","margin-left":"5px"}},null,8,["modelValue","onUpdate:modelValue","onKeyup"])]),e[31]||(e[31]=n("div",{style:{"margin-top":"5px"}},[n("strong",null,"操作:")],-1)),n("div",qe,[a(o,{size:"small",type:"primary",onClick:d=>C("bad",l.$index,1)},{default:i(()=>e[25]||(e[25]=[s("+1")])),_:2,__:[25]},1032,["onClick"]),a(o,{size:"small",type:"primary",onClick:d=>C("bad",l.$index,10)},{default:i(()=>e[26]||(e[26]=[s("+10")])),_:2,__:[26]},1032,["onClick"]),a(o,{size:"small",type:"danger",onClick:d=>Z("bad",l.$index),style:{"margin-left":"auto"}},{default:i(()=>e[27]||(e[27]=[s(" 删除 ")])),_:2,__:[27]},1032,["onClick"])]),n("div",He,[a(o,{size:"small",type:"primary",onClick:d=>C("bad",l.$index,-1)},{default:i(()=>e[28]||(e[28]=[s("-1")])),_:2,__:[28]},1032,["onClick"]),a(o,{size:"small",type:"primary",onClick:d=>C("bad",l.$index,-10)},{default:i(()=>e[29]||(e[29]=[s("-10")])),_:2,__:[29]},1032,["onClick"])])])):le("",!0)]),_:1})]),_:1},8,["data"])]),_:1}),a(ye,{title:u.value.type==="bad"?"添加坏货":"添加好货",modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=l=>w.value=l),width:"90%","close-on-click-modal":!1,"destroy-on-close":!0},{footer:i(()=>[a(o,{onClick:e[5]||(e[5]=l=>w.value=!1)},{default:i(()=>e[33]||(e[33]=[s("取消")])),_:1,__:[33]}),a(o,{type:"primary",onClick:re},{default:i(()=>e[34]||(e[34]=[s("确定")])),_:1,__:[34]})]),default:i(()=>[n("div",Ye,[a(fe,{"label-position":"top","label-width":"80px"},{default:i(()=>[a(W,{label:"货物ID"},{default:i(()=>[a(F,{modelValue:u.value.id,"onUpdate:modelValue":e[2]||(e[2]=l=>u.value.id=l)},null,8,["modelValue"]),a(o,{type:"primary",plain:"",size:"small",style:{"margin-top":"5px"},onClick:e[3]||(e[3]=l=>k.value=!0)},{default:i(()=>e[32]||(e[32]=[s("扫码输入")])),_:1,__:[32]})]),_:1}),a(W,{label:"数量"},{default:i(()=>[a(pe,{modelValue:u.value.count,"onUpdate:modelValue":e[4]||(e[4]=l=>u.value.count=l),min:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})])]),_:1},8,["title","modelValue"]),a($e,{modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=l=>k.value=l),onSuccess:y},null,8,["modelValue"])])}}},et=ie(Ge,[["__scopeId","data-v-741dd871"]]);export{et as default};
